# 프로세스와 스레드

## 프로세스

프로세스는 <span style="background-color:#fff5b1">실행 중인 프로그램</span>으로 디스크로부터 메모리에 적재되어 CPU의 할당을 받을 수 있는 것을 말한다. 

운영체제로부터 주소 공간, 파일, 메모리 등을 할당받으며 이것들을 총칭하여 프로세스라고 한다.

> "프로그램은 코드 덩어리 파일, 그 프로그램을 실행한 것이 프로세스" <br /> <br />
프로그램은 독립적인 메모리 공간을 할당받지 않고, 정적으로 존재하는 상태이다. (실행할 수 있는 파일을 통칭)
<br /> 프로그램을 실행하는 순간, **동적인** 상태가 되고 이 상태의 프로그램이 프로세스이다. (작업 중인 프로그램을 통칭)

![image](https://github.com/pildrums/woojoo_land/assets/83483378/24adde12-a789-41a1-bcf8-b6a9952566fa)

모든 프로그램은 운영체제가 실행되기 위한 메모리 공간을 할당해 줘야 실행될 수 있다. 그래서 프로그램을 실행하는 순간 파일은 컴퓨터 메모리에 올라가게 되고, 운영체제로부터 시스템 자원(CPU)을 할당받아 프로그램 코드를 실행시켜 우리가 서비스를 이용할 수 있게 되는 것이다.

<br />


### 프로세스의 자원구조
프로그램이 실행되어 프로세스가 만들어지면 다음 4가지의 메모리 영역으로 구성되어 할당 받게 된다.

![image](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FbrkLMD%2Fbtr62G1oUxX%2FViLrf3C3n5j2Vi5rUuroUk%2Fimg.png)


1. 코드 영역(Code / Text) : 프로그래머가 작성한 프로그램 함수들의 코드가 CPU가 해석 가능한 기계어 형태로 저장되어 있다.
2. 데이터 영역(Data) : 코드가 실행되면서 사용하는 전역 변수나 각종 데이터들이 모여있다. 데이터영역은 .data ,.rodata, .bss 영역으로 세분화 된다.

    - .data : `전역 변수 또는 static 변수 등 프로그램이 사용하는 데이터`를 저장
    - .BSS : `초기값 없는 전역 변수`, `static 변수`가 저장
    - .rodata : `const` 같은 상수 키워드 선언 된 변수나 `문자열 상수`가 저장


2. 스택 영역(Stack) : 지역 변수와 같은 호출한 함수가 종료되면 되돌아올 임시적인 자료를 저장하는 독립적인 공간이다. Stack은 함수의 호출과 함께 할당되며, 함수의 호출이 완료되면 소멸한다. 만일 stack 영역을 초과하면 stack overflow 에러가 발생한다.
3. 힙 영역(Heap) : 생성자, 인스턴스와 같은 동적으로 할당되는 데이터들을 위해 존재하는 공간이다. 사용자에 의해 메모리 공간이 동적으로 할당되고 해제된다.

위의 그림에서 Stack과 Heap 영역이 위아래로 화살표가 쳐 있는 것을 볼 수 있는데, 이는 코드 영역과 데이터 영역은 선언할 때 그 크기가 결정되는 정적 영역이지만, **스택 영역과 힙 영역은 프로세스가 실행되는 동안 크기가 늘어났다 줄어들기도 하는 동적 영역이기 때문에 이를 표현한 것이다.**

<br />
<br />
<br />

## 스레드
**스레드는 프로세스의 실행 단위**라고 할 수 있다.

![image](https://velog.velcdn.com/images/1017yu/post/6e67e613-7fd8-46eb-8528-c376d78ef537/image.png)
> 스레드는 한 프로세스 내에서 동작되는 여러 실행 흐름으로 프로세스 내의 주소 공간이나 자원을 공유할 수 있다. 

스레드는 스레드 ID, 프로그램 카운터, 레지스터 집합, 그리고 스택으로 구성된다. 같은 프로세스에 속한 다른 스레드와 코드, 데이터 섹션, 그리고 열린 파일이나 신호와 같은 운영체제 자원들을 공유한다.

<br />

### 스레드의 자원 공유

![image](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fc6hP8P%2Fbtr5A5vOmq1%2Flc1Ya3NafKtUsg6s10SCIK%2Fimg.png)
프로세스의 4가지 메모리 영역(Code, Data, Heap, Stack) 중 `스레드는 Stack만 할당받아 복사`하고 Code, Data, Heap은 프로세스내의 다른 스레드들과 공유된다. 

따라서 각각의 스레드는 별도의 stack을 가지고 있지만 heap 메모리는 고유하기 때문에 서로 다른 스레드에서 가져와 읽고 쓸 수 있게 된다.


>stack은 함수 호출 시 전달되는 인자, 되돌아갈 주소값, 함수 내에서 선언하는 변수 등을 저장하는 메모리 공간이기 때문에, 독립적인 스택을 가졌다는 것은 독립적인 함수 호출이 가능하다 라는 의미이다.
<br /> <br /> 그리고 독립적인 함수 호출이 가능하다는 것은 독립적인 실행 흐름이 추가된다는 말이다. <br />즉, stack을 가짐으로써 스레드는 독립적인 실행 흐름을 가질 수 있게 되는 것이다.


<br />
<br />

## 싱글 스레드 언어의 자바스크립트, 그리고 다중 스레드

### 싱글 스레드 vs 다중 스레드

|    | 장점 | 단점 |
|----------|----------|----------|
| 싱글 스레드    | 공용 자원에 대한 접근을 통제받지 않으므로 동기화를 신경쓰지 않아도 된다. <br /> 작업전환 작업을 요구하지 않는다. (저비용)    | 여러 개의 CPU를 활용하지 못한다. <br />  두 개의 작업을 두 개의 스레드로 처리하는 경우보다 하나의 스레드로 처리하는 경우가 더 긴 시간을 요구한다.|
| 멀티 스레드   | 새로운 프로세스를 생성하는 것보다 기존 프로세스에서 스레드를 생성하는 것이 빠르다. <br /> 프로세스의 자원과 상태를 공유하여 효율적으로 운영이 가능하다. |  하나의 스레드만 실행중일 때는 실행시간이 오히려 지연될 수 있다. <br /> 멀티 스레딩을 위해 운영체제의 지원이 필요하다.|

<br />

---

### 자바스크립트는 왜 싱글 스레드 언어가 되었나?

![image](https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSZJ7J_LUwxTFJkSXXKOPJQq1VS-ianIsxBIQ&usqp=CAU)

자바스크립트는 원래 웹페이지의 보조적인 기능을 수행하려고 만들어진 언어이다. 멀티 스레드 언어가 가진 무거움, <span style="background-color:#FFE6E6">동시성 문제</span> 등 복잡한 문제점을 신경쓸 필요 없는 싱글 스레드 형식이 채택되었다.

>사용자에게 있어서 화면이라는 자원(UI 스레드(메인 스레드))에 여러 스레드가 동시에 접근하게 된다면 문제가 발생할 여지가 생기게 된다. <br />
UI 스레드 이외의 다른 스레드에서는 UI 작업을 하지 말아야 한다는 뜻으로, 같은 이벤트에 동시에 다른 요청을 받았을 때, 우리가 기대했던 결과가 아닌 다른 결과를 맞이할 수 있기 때문



실제로 구글 Chrome 브라우저는 기존 웹 페이지에서 동시성 문제를 일으킬 수 있다는 이유로 단일 웹 사이트 페이지의 자바스크립트 코드가 동시에 실행되는 것을 허용하지 않는다.

<br />

### 그렇다면 자바 스크립트는 싱글 스레드로 동작하는가?

자바스크립트의 메인 스레드인 `이벤트 루프가 싱글 스레드`이기 때문에 싱글 스레드라고 부른다. 

하지만 이벤트 루프만 독립적으로 실행되지는 않고 **웹 브라우저나 NodeJS같은 멀티 스레드 환경에서 실행된다.** <br /> 즉, `자바스크립트 자체는 싱글 스레드이지만 자바스크립트 런타임은 싱글 스레드가 아니다.`

> 자바스크립트 런타임 자체에서 비동기 API를 지원하는가? <br />
아니다. 정확히는 자바스크립트 엔진을 구동하는 런타임 환경에서 담당한다. 즉, 브라우저 혹은 Node.js가 담당한다.


<br />

### 싱글 스레드로 어떻게 여러 요청을 처리하는가?

자바스크립트가 싱글 스레드 언어이므로 아래의 코드의 결과는 코드의 작성 순서대로 `console.log()`가 실행되는가?

```js
console.log("GS25");

setTimeout(() => console.log("이마트 24"), 1000);

console.log("CU");
```

<details>
<summary>결과</summary>

![image](https://github.com/pildrums/woojoo_land/assets/83483378/7b0131c3-2d97-4a25-b4c7-b4010bed23d6)

</details>

<br />
<br />
<br />

만약 setTimeout의 시간을 0초로 바꿔 즉시 실행하도록 한다면?

```js
console.log("GS25");

setTimeout(() => console.log("이마트 24"), 0);

console.log("CU");
```

<details>
<summary>결과</summary>

![image](https://github.com/pildrums/woojoo_land/assets/83483378/a145a459-2bb5-4833-9eaa-0b9afecfc5ba)

</details>

<br />
<br />

이후에는 JS Event Loop의 Call Stack 항목에서 알아보자.
